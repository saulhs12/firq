name: ci

on:
  push:
  pull_request:

jobs:
  rust:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: fmt
        run: cargo fmt --all -- --check
      - name: clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
      - name: test-core
        run: cargo test -p firq-core
      - name: test-async
        run: cargo test -p firq-async
      - name: test-tower
        run: cargo test -p firq-tower --test integration
      - name: check-examples
        run: cargo check -p firq-examples --bins
      - name: publish-dry-run-core
        run: cargo publish --dry-run -p firq-core
      - name: publish-dry-run-async-if-core-published
        run: |
          if cargo search firq-core --limit 1 | grep -q '^firq-core = '; then
            cargo publish --dry-run -p firq-async
          else
            echo "Skipping firq-async dry-run until firq-core is available on crates.io"
          fi
      - name: publish-dry-run-tower-if-async-published
        run: |
          if cargo search firq-async --limit 1 | grep -q '^firq-async = '; then
            cargo publish --dry-run -p firq-tower
          else
            echo "Skipping firq-tower dry-run until firq-async is available on crates.io"
          fi

  publish:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: rust
    runs-on: ubuntu-latest
    env:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@stable
      - name: ensure-jq
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi
      - name: validate-token
        run: |
          if [ -z "${CARGO_REGISTRY_TOKEN:-}" ]; then
            echo "::error::CARGO_REGISTRY_TOKEN secret is required for crates.io publishing"
            exit 1
          fi
      - name: publish-crates
        run: |
          set -euo pipefail

          CRATES_IO_API="https://crates.io/api/v1/crates"
          USER_AGENT="firq-publish-ci (https://github.com/saulhs12/firq)"

          event_before="$(jq -r '.before // empty' "$GITHUB_EVENT_PATH")"
          base_ref=""
          if [ -n "$event_before" ] && [ "$event_before" != "0000000000000000000000000000000000000000" ]; then
            base_ref="$event_before"
            if ! git cat-file -e "${base_ref}^{commit}" 2>/dev/null; then
              git fetch --no-tags --prune --depth=200 origin "$base_ref" || true
            fi
            if ! git cat-file -e "${base_ref}^{commit}" 2>/dev/null; then
              echo "::warning::unable to resolve push base commit ${base_ref}; changed-crate version check disabled"
              base_ref=""
            fi
          fi

          local_version() {
            local crate="$1"
            cargo metadata --no-deps --format-version 1 \
              | jq -r --arg crate "$crate" '.packages[] | select(.name == $crate) | .version'
          }

          crate_changed_in_push() {
            local crate="$1"
            if [ -z "$base_ref" ]; then
              return 1
            fi
            git diff --name-only "$base_ref" "$GITHUB_SHA" -- "crates/${crate}/" | grep -q .
          }

          remote_version() {
            local crate="$1"
            local body
            body="$(curl -sSL -H "User-Agent: ${USER_AGENT}" "${CRATES_IO_API}/${crate}" || true)"
            if [ -z "$body" ]; then
              echo ""
              return 0
            fi
            echo "$body" | jq -r '.crate.max_version // empty' 2>/dev/null || true
          }

          publish_once() {
            local crate="$1"
            set +e
            local output
            output="$(cargo publish -p "$crate" 2>&1)"
            local status=$?
            set -e
            echo "$output"
            if [ $status -eq 0 ]; then
              return 0
            fi
            if echo "$output" | grep -Eqi "already uploaded|already exists on crates\.io index"; then
              echo "crate ${crate} already uploaded; continuing"
              return 0
            fi
            return $status
          }

          publish_with_retry() {
            local crate="$1"
            local attempts=6
            local delay_seconds=20
            for attempt in $(seq 1 "$attempts"); do
              if publish_once "$crate"; then
                return 0
              fi
              if [ "$attempt" -lt "$attempts" ]; then
                echo "publish failed for ${crate} (attempt ${attempt}/${attempts}), retrying in ${delay_seconds}s..."
                sleep "$delay_seconds"
              fi
            done
            echo "::error::failed to publish ${crate} after retries"
            return 1
          }

          for crate in firq-core firq-async firq-tower; do
            local_ver="$(local_version "$crate")"
            remote_ver="$(remote_version "$crate")"
            changed_in_push=0
            if crate_changed_in_push "$crate"; then
              changed_in_push=1
            fi

            echo "${crate}: local=${local_ver} remote=${remote_ver:-<unknown>}"
            if [ -n "$remote_ver" ] && [ "$remote_ver" = "$local_ver" ]; then
              if [ "$changed_in_push" -eq 1 ]; then
                echo "::error::${crate} changed in this push but version remained ${local_ver}. bump crates/${crate}/Cargo.toml version before publishing."
                exit 1
              fi
              echo "${crate} ${local_ver} already on crates.io; skipping"
              continue
            fi
            echo "publishing ${crate} ${local_ver}..."
            publish_with_retry "$crate"
          done
